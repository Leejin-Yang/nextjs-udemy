# 페이지 사전 렌더링 & 데이터 페칭

## React와 Nextjs 비교

### React 앱의 문제점

fetch한 데이터는 js 코드에 데이터를 로딩한 것이 아니다. 파일을 import하는 방식이 아니다. 대신 설정이 모두 끝나고 브라우저에서 실행되고 있을 때 해당 파일에 HTTP 요청을 보내는 방식이다. 그 후 추출한 데이터를 로딩하고 상태 설정과 데이터 렌더링을 시작한다. **\*\***렌더링된 DOM에서는 표시가 되는데 이는 JS와 React를 통한 렌더링이 끝나야지만 본 페이지에서 로딩된다.

**_페이지 소스를 보면 어디에서도 데이터를 찾아볼 수 없다._**

이는 몇 가지 단점이 있는데 사용자들이 데이터가 실질적으로 페이지에 로딩되기까지 기다려야한다. 이렇게 데이터를 페칭하면 사용자 경험의 최적화라고 할 수 없다. 괜찮을 수도 있겠지만 더 나아질 여지가 있는 것이다.

검색 엔진 최적화에도 문제가 있다. 콘텐츠를 구글이 알아야하는데 검색 엔진은 콘텐츠가 없는 데이터를 보게 된다. 재전송 방식은 적합하지 않다. 검색엔진이 상관 없다면(대시보드나 로그인) 괜찮지만 콘텐츠가 많은 앱의 경우 필요하다.

### Nextjs

pre-rendering 개념을 이용해서 위와 같은 문제의 해결을 돕는다.

사용자가 페이지를 방문해 요청이 전송되면 Nextjs가 pre-render된 페이지를 반환한다. 페이지를 다시 클라이언트로 전송된 뒤에만 데이터를 로딩하는 대신 필요할 법한 모든 데이터가 있는 HTML 콘텐츠를 사전에 렌더링한다. 사전에 HTML 페이지를 완성해 놓고 완전히 채워진 HTML 파일을 클라이언트에게 전송한다. SEO에도 뛰어나다!

하지만 Interactive React 앱이 필요하다. 사용자와 상호작용하기 위해서. Nextjs는 단순히 pre-rendering된 페이지를 재전송하는데 그치지 않고 포함된 js 코드를 모두 재전송한다. 이런 재전송을 해당 페이지에 대해 hydrate한다고 한다. 재전송된 js코드는 나중에 pre-rendering된 페이지를 대체하고 이에 React가 알맞은 작업을 수행한다.

주요 콘텐츠가 모두 포함되어 있는 상태이기 때문에 검색엔진크롤러도 모든 콘텐츠를 살펴보게 된다.

요약하면 Nextjs는 페이지를 사전에 준비하는데 이때 모든 HTML 콘텐츠를 사전에 구축하고 필요할 모든 데이터릴 사전에 로딩하는 방식을 따른다. **_사전 렌더링은 오직 최초 로딩할 때만 영향을 미친다._** 페이지를 방문하면 로딩되는 첫 번째 페이지가 pre-rendering 된 것이다. 첫 번째 렌더링이 끝나고 나면 다시 SPA로 돌아간다. 그때부터 React가 프론트엔드에서 모든 처리를 수행한다. 그 후에 페이지가 바뀔 때 해당 페이지가 pre-rendering되지 않고 React를 통해 클라이언트 사이드에서 생성된다. pre-rendering되는 건 최초 접속하는 첫 번째 페이지 뿐!

Nextjs에는 두 가지 pre-rendering 양식이 있다.

- Static Generation (정적 생성)
- Server-side Rendering

둘의 차이점은 정적 생성은 빌드되는 동안 모든 페이지가 사전 생성된다는 것이다. 따라서 프로덕션용 앱을 구축한다면 배포 전에 모든 페이지가 준비된다는 것. SSR의 경우 배포 후 요청이 서버까지 오는 바로 그때 모든 페이지가 생성된다.

## Static Generation

일반적으로 권장되는 방법. 빌드하는 동안 페이지를 사전 생성하는 것이다. 즉 보통 서버 사이드에서만 실행되는 코드를 빌드 프로세스 동안 실행하도록 허용한다. 빌드 시간(앱을 구축할 때) 중 데이터와 페이지가 준비된다. 배포되고 나면 구축된 페이지는 서버나 앱을 실행시키는 CDN을 통해서 캐시로 저장된다. 이에 사전 구축된 페이지를 통해서 즉시 입력 요청이 실행될 수 있다. 클라이언트에게 전송되는 페이지와의 차이점이라고 하면 빈 페이지가 아닌 사전에 콘텐츠로 채워져 있다는 점이다.

이때 문제점은 어떤 페이지를 사전에 생성해야 하는지 지정하는 일이다. 페이지 컴포넌트에서 가져올 수 있는 특정 함수가 있다. 반드시 사용하는 페이지 컴포넌트 내부에 있어야 한다.

```tsx
export async function getStaticProps(context) {...}
// getStaticProps 이름 fix
// Promise를 반환하는 비동기 함수로 await 키워드를 사용할 수 있다.
```

보통 서버 사이드에서만 실행되는 모든 코드도 실행할 수가 있다. 함수 안에 작성한 코드는 클라이언트에게 재전송되는 코드로 포함되지 않는다. 클라이언트는 볼 수 없다.

**_Nextjs는 동적 데이터가 없는 모든 페이지를 pre-rendering한다._**

### getStaticProps

페이지를 사전 생성할 때 사용자를 대신하여 getStaticProps를 호출. 이 함수는 페이지가 사전 생성되어야 하는 페이지임을 알려준다. 기본값으로 pre-rendering을 하지만 사전에 렌더링 하지 않게 하는 방법도 있기 때문에 여전히 사전 생성되어야 하도록 한다는 것을 알려준다.

페이지가 로드된 후에만 클라이언트 사이드에서 전송되는 HTTP 요청 대신 컴포넌트를 생성하기 전에 Nextjs가 pre-rendering 하기 전에 데이터를 pre-fetch해야 한다.

**_항상 props 키를 포함한 객체를 반환해야 한다._**

이 함수가 하는 일은 컴포넌트에 대한 프로퍼티를 준비하는 것이다. 이 함수가 페이지 컴포넌트에 있다면 이 함수를 먼저 실행하고 다음에 컴포넌트 함수를 실행한다.

사전에 두 가지 작업을 모두 수행하기 때문에 클라이언트 사이드에서는 모두 실행되지 않는다. 빌드되는 시간 동안이나 사용 중인 개발 서버의 일부로 개발 중에 발생한다.

- 데이터 fetching은 서버에서 이루어진다.
- js 소스코드에서 코드를 확인할 수 없다 (클라이언트 사이드에서 실행되지 않기 때문에)

사용자가 볼 수 없는 credential을 쓸 수 있고 브라우저에서 작동하지 않는 코드를 실행할 수 있다.
